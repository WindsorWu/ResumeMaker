import{r as l,j as c}from"./vendor-BJAOCLFF.js";import{d as w,e as v,D as y,f as E,g as I,h as b,i as k,B as x}from"./index-DCScVb7o.js";import{b as j}from"./state-BErW7EvM.js";import{L as S,B as T,S as A}from"./image-crop-DlUlnxqA.js";import"./utils-uvPUNtyq.js";import"./lucide-react-rgKbjvdd.js";import"./ui-vendor-Brtqijad.js";import"./dnd-kit-CF5ZvFCr.js";import"./router-Lx8uxIVW.js";const D=()=>{const t=j(w),e=j(v),n=l.useCallback((o,s)=>{const r=t({message:o,type:"error",duration:s??5e3});s!==0&&setTimeout(()=>{e(r)},s??5e3)},[t,e]),d=l.useCallback((o,s)=>{const r=t({message:o,type:"warning",duration:s??4e3});s!==0&&setTimeout(()=>{e(r)},s??4e3)},[t,e]),a=l.useCallback((o,s)=>{const r=t({message:o,type:"info",duration:s??3e3});s!==0&&setTimeout(()=>{e(r)},s??3e3)},[t,e]),i=l.useCallback((o,s)=>{const r=t({message:o,type:"success",duration:s??3e3});s!==0&&setTimeout(()=>{e(r)},s??3e3)},[t,e]),m=l.useCallback(o=>{const s=t(o);return o.duration&&o.duration>0&&setTimeout(()=>{e(s)},o.duration),s},[t,e]),p=l.useCallback((o,s="操作失败，请重试")=>{const r=o instanceof Error?o.message:s;n(r),console.error("Async operation error:",o)},[n]);return{showError:n,showWarning:d,showInfo:a,showSuccess:i,addMessage:m,handleAsyncError:p}};function L(t){return t.toDataURL("image/jpeg",.9)}async function M(t,e){const n=document.createElement("canvas"),d=n.getContext("2d"),a=t.naturalWidth/t.width,i=t.naturalHeight/t.height;return n.width=e.width*a,n.height=e.height*i,d.drawImage(t,e.x*a,e.y*i,e.width*a,e.height*i,0,0,e.width*a,e.height*i),L(n)}const N=(t,e)=>{const[n,d]=l.useState(),[a,i]=l.useState(),m=l.useRef(null),{showError:p}=D(),o=l.useCallback(h=>{const{width:u,height:C}=h.currentTarget,f=S(T({unit:"%",width:80},3/4,u,C),u,C);d(f),i(f)},[]);return{crop:n,completedCrop:a,imgRef:m,onImageLoad:o,onCropChange:(h,u)=>{d(u)},onCropComplete:h=>{i(h)},handleSave:async()=>{if(a&&m.current)try{const h=await M(m.current,a);t(h),e()}catch(h){console.error("Failed to crop image:",h),p("请上传头像后裁剪")}},handleCancel:()=>{e()}}},q=({isOpen:t,onClose:e,imageSrc:n,onCropComplete:d})=>{const{crop:a,completedCrop:i,imgRef:m,onImageLoad:p,onCropChange:o,onCropComplete:s,handleSave:r,handleCancel:g}=N(d,e);return c.jsx(y,{open:t,onOpenChange:e,children:c.jsxs(E,{className:"max-w-2xl",children:[c.jsxs(I,{children:[c.jsx(b,{children:"裁剪头像"}),c.jsx(k,{children:"拖拽调整裁剪区域，点击保存完成头像设置。"})]}),c.jsxs("div",{className:"space-y-4",children:[c.jsx("div",{className:"flex justify-center",children:c.jsx(A,{crop:a,onChange:o,onComplete:s,aspect:3/4,children:c.jsx("img",{ref:m,src:n,alt:"裁剪头像",onLoad:p,className:"max-h-96"})})}),c.jsxs("div",{className:"flex justify-end gap-2",children:[c.jsx(x,{variant:"outline",onClick:g,children:"取消"}),c.jsx(x,{onClick:r,disabled:!i,children:"保存"})]})]})]})})};export{q as AvatarCropper,q as default};
